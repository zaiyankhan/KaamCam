format_version: "13"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: cordova

app:
  envs:
    - CORDOVA_PROJECT_DIR: kaamcam-app
    - BUNDLE_ID: com.kaamcam.app
    - APP_NAME: KaamCam
    - PRODUCTION_URL: https://kaamcam.com

trigger_map:
  - push_branch: main
    workflow: primary
  - push_branch: master
    workflow: primary
  - push_branch: develop
    workflow: develop
  - pull_request_source_branch: "*"
    workflow: develop

workflows:
  develop:
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@8: {}
      - script@1:
          title: Install Cordova, Gradle 8, and Android SDK
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                npm install -g cordova@12
                brew install gradle@8
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                yes | sdkmanager --install "build-tools;33.0.2" "platforms;android-34"
      - script@1:
          title: Create and setup Cordova project
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                cordova create $CORDOVA_PROJECT_DIR $BUNDLE_ID "$APP_NAME"
                cd $CORDOVA_PROJECT_DIR
                cp ../config.xml ./config.xml
                rm -rf www && cp -r ../www ./www
                [ -d "../res" ] && cp -r ../res ./res
                cordova platform add android@12
                cordova plugin add cordova-plugin-device cordova-plugin-camera cordova-plugin-geolocation cordova-plugin-file cordova-plugin-network-information cordova-plugin-statusbar cordova-plugin-media-capture cordova-plugin-inappbrowser
      - script@1:
          title: Build Debug APK
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                cd $CORDOVA_PROJECT_DIR
                cordova build android --debug
                APK_PATH=$(find . -name "*debug*.apk" -type f | head -1)
                [ -z "$APK_PATH" ] && APK_PATH=$(find . -name "*.apk" -type f | head -1)
                if [ -f "$APK_PATH" ]; then
                  cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/kaamcam-debug.apk"
                  envman add --key BITRISE_APK_PATH --value "$BITRISE_DEPLOY_DIR/kaamcam-debug.apk"
                fi
      - deploy-to-bitrise-io@2: {}

  primary:
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@8: {}
      - script@1:
          title: Install Cordova, Gradle 8, and Android SDK
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                npm install -g cordova@12
                brew install gradle@8
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                yes | sdkmanager --install "build-tools;33.0.2" "platforms;android-34"
      - script@1:
          title: Create and setup Cordova project
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                cordova create $CORDOVA_PROJECT_DIR $BUNDLE_ID "$APP_NAME"
                cd $CORDOVA_PROJECT_DIR
                cp ../config.xml ./config.xml
                rm -rf www && cp -r ../www ./www
                [ -d "../res" ] && cp -r ../res ./res
                cordova platform add android@12
                cordova plugin add cordova-plugin-device cordova-plugin-camera cordova-plugin-geolocation cordova-plugin-file cordova-plugin-network-information cordova-plugin-statusbar cordova-plugin-media-capture cordova-plugin-inappbrowser
      - script@1:
          title: Build Release APK
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                export PATH="/opt/homebrew/opt/gradle@8/bin:$PATH"
                cd $CORDOVA_PROJECT_DIR
                cordova build android --release -- --packageType=apk
                APK_PATH=$(find . -name "*release*.apk" -type f | head -1)
                [ -z "$APK_PATH" ] && APK_PATH=$(find . -name "*.apk" -type f | head -1)
                if [ -f "$APK_PATH" ]; then
                  cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/kaamcam-release.apk"
                  envman add --key BITRISE_APK_PATH --value "$BITRISE_DEPLOY_DIR/kaamcam-release.apk"
                fi
                AAB_PATH=$(find . -name "*.aab" -type f | head -1)
                if [ -f "$AAB_PATH" ]; then
                  cp "$AAB_PATH" "$BITRISE_DEPLOY_DIR/kaamcam-release.aab"
                fi
      - sign-apk@1:
          run_if: '{{getenv "BITRISEIO_ANDROID_KEYSTORE_URL" | ne ""}}'
          inputs:
            - apk_path: $BITRISE_APK_PATH
      - deploy-to-bitrise-io@2: {}

  ios:
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@8: {}
      - script@1:
          title: Install Cordova CLI
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                npm install -g cordova@12
      - script@1:
          title: Create and setup Cordova project
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                cordova create $CORDOVA_PROJECT_DIR $BUNDLE_ID "$APP_NAME"
                cd $CORDOVA_PROJECT_DIR
                cp ../config.xml ./config.xml
                rm -rf www && cp -r ../www ./www
                [ -d "../res" ] && cp -r ../res ./res
                cordova platform add ios@7
                cordova plugin add cordova-plugin-device cordova-plugin-camera cordova-plugin-geolocation cordova-plugin-file cordova-plugin-network-information cordova-plugin-statusbar cordova-plugin-media-capture cordova-plugin-inappbrowser
      - certificate-and-profile-installer@1: {}
      - script@1:
          title: Build iOS Release
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                cd $CORDOVA_PROJECT_DIR
                cordova build ios --release --device
                IPA_PATH=$(find platforms/ios -name "*.ipa" | head -1)
                [ -f "$IPA_PATH" ] && cp "$IPA_PATH" "$BITRISE_DEPLOY_DIR/kaamcam-release.ipa" && envman add --key BITRISE_IPA_PATH --value "$BITRISE_DEPLOY_DIR/kaamcam-release.ipa"
      - deploy-to-bitrise-io@2: {}

meta:
  bitrise.io:
    stack: osx-xcode-16.4.x
    machine_type_id: g2-m1.4core